#!/usr/bin/env bash

set -o errexit -o nounset

function fail {
    echo "Error:" "$@"
    exit 1
} 1>&2


DIR="${1:-.}"
DOTFILES_ORIGIN="${2:-/etc/nixos/users/dotfiles}"

cd "$DIR"
[ -e .dotfiles ] && fail "$DIR/.dotfiles already exists!"

chmod -v og-rwx "$DIR"

# Arrange for the Git repository directory to be .dotfiles instead of .git, to
# avoid seeing $DIR (e.g. $HOME) by default as a repository.
git clone --separate-git-dir=.dotfiles "$DOTFILES_ORIGIN" .
git checkout -b user/"$USER" --no-track
mv -v .git .git-hidden

# TODO: install home-manager for user and do `home-manager switch`.
